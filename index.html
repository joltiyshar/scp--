<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SCP FOUNDATION ‚Äî –û–ë–™–ï–ö–¢–ù–ê–Ø –ë–ê–ó–ê –î–ê–ù–ù–´–•</title>
<link href="https://fonts.googleapis.com/css2?family=Special+Elite&family=Share+Tech+Mono&family=Courier+Prime:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>
:root {
  --bg:#080808;--bg2:#0d0d0b;--surface:#111109;--surface2:#181815;
  --border:#2a2a24;--border2:#3d3d32;
  --text:#c8c4a8;--text-dim:#6b6858;--text-bright:#e0dcc4;
  --red:#cc1111;--red2:#991111;--red-dim:#4a0808;
  --amber:#c4920a;--amber-dim:#6b4f05;
  --green:#4a7a30;--green-dim:#1e3010;
  --mono:'Share Tech Mono','Courier New',monospace;
  --serif:'Courier Prime','Courier New',monospace;
  --title:'Special Elite','Courier New',monospace;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;}
body{background:var(--bg);color:var(--text);font-family:var(--serif);font-size:15px;overflow:hidden;cursor:crosshair;}

/* scanlines */
body::after{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.08) 2px,rgba(0,0,0,.08) 4px);pointer-events:none;z-index:9998;}
/* noise */
body::before{content:'';position:fixed;inset:-50%;width:200%;height:200%;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");animation:noise .4s steps(1) infinite;pointer-events:none;z-index:9997;opacity:.4;}
@keyframes noise{0%,100%{transform:translate(0,0)}10%{transform:translate(-2px,1px)}20%{transform:translate(2px,-1px)}30%{transform:translate(-1px,2px)}40%{transform:translate(1px,-2px)}50%{transform:translate(-2px,-1px)}60%{transform:translate(2px,2px)}70%{transform:translate(-1px,-1px)}80%{transform:translate(1px,1px)}90%{transform:translate(0,-2px)}}

/* BOOT */
#bootScreen{position:fixed;inset:0;background:#000;z-index:9000;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:var(--mono);font-size:13px;color:#cc1111;}
.boot-logo{font-size:52px;margin-bottom:20px;letter-spacing:6px;}
.boot-line{color:#555;margin:2px 0;}.boot-line.ok{color:#4a7a30;}.boot-line.warn{color:var(--amber);}
.blink{animation:blink 1s step-end infinite;}
@keyframes blink{50%{opacity:0;}}

/* HEADER */
header{height:56px;background:var(--bg2);border-bottom:2px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:16px;z-index:100;flex-shrink:0;}
.scp-logo{font-family:var(--title);font-size:20px;color:var(--red);letter-spacing:3px;display:flex;align-items:center;gap:10px;white-space:nowrap;}
.header-mid{flex:1;font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:1px;line-height:1.6;}
.header-right{display:flex;align-items:center;gap:10px;}
.access-badge{font-family:var(--mono);font-size:10px;padding:4px 10px;border:1px solid;letter-spacing:2px;}
.access-badge.ro{color:var(--text-dim);border-color:var(--border2);}
.access-badge.adm{color:var(--amber);border-color:var(--amber-dim);animation:pAmber 2s ease infinite;}
@keyframes pAmber{0%,100%{box-shadow:0 0 4px rgba(196,146,10,.3)}50%{box-shadow:0 0 12px rgba(196,146,10,.7)}}
.hbtn{display:inline-flex;align-items:center;gap:4px;padding:5px 10px;border:1px solid var(--border2);background:transparent;color:var(--text-dim);font-family:var(--mono);font-size:10px;cursor:pointer;letter-spacing:2px;text-transform:uppercase;transition:all .15s;}
.hbtn:hover{border-color:var(--red2);color:var(--red);}
.hbtn.danger{border-color:var(--red2);color:var(--red);}
.hbtn.danger:hover{background:var(--red-dim);}

/* LAYOUT */
.app{display:flex;height:calc(100vh - 56px);overflow:hidden;}

/* SIDEBAR */
.sidebar{width:268px;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;flex-shrink:0;overflow:hidden;}
.sb-head{padding:12px 16px;border-bottom:1px solid var(--border);background:var(--bg2);}
.sb-label{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.sb-label::before{content:'';width:6px;height:6px;background:var(--red);animation:pRed 1.5s ease infinite;}
@keyframes pRed{0%,100%{opacity:1;box-shadow:0 0 4px var(--red)}50%{opacity:.3;}}
.sb-search{background:transparent;border:1px solid var(--border);color:var(--text);font-family:var(--mono);font-size:12px;padding:6px 10px;width:100%;outline:none;letter-spacing:1px;}
.sb-search:focus{border-color:var(--red2);}.sb-search::placeholder{color:var(--text-dim);}
.entity-list{flex:1;overflow-y:auto;padding:6px 0;}
.entity-list::-webkit-scrollbar{width:4px;}.entity-list::-webkit-scrollbar-thumb{background:var(--border2);}
.ent{padding:10px 16px;cursor:pointer;border-left:3px solid transparent;border-bottom:1px solid rgba(42,42,36,.5);transition:all .15s;position:relative;}
.ent:hover{background:var(--surface2);border-left-color:var(--border2);}
.ent.active{background:var(--surface2);border-left-color:var(--red);}
.ent-num{font-family:var(--mono);font-size:10px;color:var(--text-dim);margin-bottom:3px;letter-spacing:1px;}
.ent-name{font-family:var(--title);font-size:14px;color:var(--text-bright);margin-bottom:4px;}
.ent-name:hover{animation:glitch .3s linear;}
@keyframes glitch{0%,100%{text-shadow:none}20%{text-shadow:-2px 0 var(--red)}50%{text-shadow:2px 0 var(--amber)}80%{text-shadow:-1px 0 rgba(100,200,255,.5)}}
.tbadge{display:inline-block;font-family:var(--mono);font-size:9px;padding:1px 6px;letter-spacing:2px;font-weight:bold;}
.tbadge.SAFE{background:var(--green-dim);color:#6ab040;border:1px solid var(--green);}
.tbadge.EUCLID{background:#4a3800;color:#c4920a;border:1px solid var(--amber-dim);}
.tbadge.KETER{background:var(--red-dim);color:#ff4444;border:1px solid var(--red2);animation:gRed 2s ease infinite;}
.tbadge.THAUMIEL{background:#0a1a3a;color:#4488cc;border:1px solid #224466;}
.tbadge.NEUTRALIZED{background:#1a1a1a;color:#666;border:1px solid #333;text-decoration:line-through;}
@keyframes gRed{0%,100%{box-shadow:0 0 4px rgba(204,17,17,.4)}50%{box-shadow:0 0 10px rgba(204,17,17,.8)}}
.ent-del{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--red2);cursor:pointer;font-size:13px;opacity:0;transition:opacity .15s;padding:4px;}
.ent:hover .ent-del{opacity:1;}
.sb-foot{padding:12px 16px;border-top:1px solid var(--border);background:var(--bg2);}
.sbtn{display:flex;align-items:center;justify-content:center;gap:6px;padding:7px 14px;border:1px solid var(--border2);background:transparent;color:var(--text-dim);font-family:var(--mono);font-size:11px;cursor:pointer;letter-spacing:2px;text-transform:uppercase;transition:all .15s;width:100%;}
.sbtn:hover{border-color:var(--red2);color:var(--red);}
.sbtn.danger{border-color:var(--red2);color:var(--red);}
.sbtn.danger:hover{background:var(--red-dim);box-shadow:0 0 10px rgba(204,17,17,.3);}

/* MAIN */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;color:var(--text-dim);font-family:var(--mono);text-align:center;padding:40px;gap:12px;}
.empty-state .sym{font-size:80px;opacity:.07;filter:blur(1px);margin-bottom:10px;}
.empty-state h2{font-family:var(--title);font-size:20px;color:var(--border2);letter-spacing:3px;}
.empty-state p{font-size:12px;letter-spacing:1px;opacity:.6;max-width:360px;line-height:1.8;}

/* DOC VIEW */
.doc-view{flex:1;display:flex;flex-direction:column;overflow:hidden;animation:fslide .25s ease;}
@keyframes fslide{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.ro-banner{background:var(--red-dim);border-bottom:1px solid var(--red2);padding:5px 20px;font-family:var(--mono);font-size:10px;color:#ff6666;letter-spacing:3px;text-transform:uppercase;text-align:center;flex-shrink:0;}

/* DOC HEADER */
.doc-header{background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;position:relative;}
.doc-id-corner{position:absolute;top:8px;right:12px;font-family:var(--mono);font-size:9px;color:var(--border2);letter-spacing:2px;}
.dh-top{display:flex;align-items:stretch;border-bottom:1px solid var(--border);}
.dh-logo{padding:14px 18px;border-right:1px solid var(--border);display:flex;align-items:center;justify-content:center;background:var(--bg2);}
.dh-info{padding:10px 18px;flex:1;}
.dh-num{font-family:var(--title);font-size:26px;color:var(--red);letter-spacing:2px;margin-bottom:4px;}
.dh-name{font-family:var(--title);font-size:21px;color:var(--text-bright);letter-spacing:1px;}
.dh-name-input{font-family:var(--title)!important;font-size:21px!important;color:var(--text-bright)!important;background:transparent;border:none!important;border-bottom:1px dashed var(--border)!important;outline:none;width:100%;padding:0!important;}
.dh-stamps{padding:10px 14px;display:flex;gap:10px;align-items:center;border-right:1px solid var(--border);flex-direction:column;justify-content:center;}
.stamp{font-family:var(--title);font-size:10px;padding:3px 7px;border:2px solid;letter-spacing:2px;opacity:.85;white-space:nowrap;}
.stamp.cl{color:#b80000;border-color:#b80000;transform:rotate(3deg);}
.stamp.re{color:var(--amber);border-color:var(--amber-dim);transform:rotate(-4deg);}
.dh-meta{display:grid;grid-template-columns:repeat(4,1fr);}
.dh-cell{padding:7px 12px;border-right:1px solid var(--border);}
.dh-cell:last-child{border-right:none;}
.dh-cell-label{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;}
.dh-cell-val{font-family:var(--mono);font-size:12px;color:var(--text-bright);}
.meta-inp{background:transparent;border:none;border-bottom:1px dashed var(--border);color:var(--text-bright);font-family:var(--mono);font-size:12px;outline:none;width:100%;}
.meta-sel{background:transparent;border:none;border-bottom:1px dashed var(--border);color:var(--text-bright);font-family:var(--mono);font-size:12px;outline:none;width:100%;cursor:pointer;}
.meta-sel option{background:var(--surface2);}

/* EDITOR PANES */
.panes{flex:1;display:flex;overflow:hidden;}

/* WRITE PANE */
.pane-write{flex:1;display:flex;flex-direction:column;border-right:1px solid var(--border);min-width:0;}
.pane-label{padding:5px 14px;background:var(--bg2);border-bottom:1px solid var(--border);font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}

/* MARKDOWN TOOLBAR */
.md-bar{padding:5px 8px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;gap:3px;flex-wrap:wrap;align-items:center;flex-shrink:0;}
.mdb{font-family:var(--mono);font-size:11px;padding:3px 7px;border:1px solid var(--border);background:transparent;color:var(--text-dim);cursor:pointer;letter-spacing:.5px;transition:all .1s;white-space:nowrap;}
.mdb:hover{border-color:var(--red2);color:var(--red);background:var(--red-dim);}
.mdb-sep{width:1px;height:16px;background:var(--border);margin:0 3px;}

/* TEXTAREA */
.md-ta{flex:1;background:var(--bg2);color:var(--text);font-family:var(--mono);font-size:13px;line-height:1.85;padding:18px 22px;border:none;outline:none;resize:none;tab-size:2;caret-color:var(--red);}
.md-ta::placeholder{color:var(--text-dim);font-style:italic;}
.md-ta::-webkit-scrollbar{width:5px;}.md-ta::-webkit-scrollbar-thumb{background:var(--border2);}

/* HINT BAR */
.md-hints{padding:6px 14px;background:var(--bg2);border-top:1px solid var(--border);font-family:var(--mono);font-size:10px;color:var(--text-dim);display:flex;gap:14px;flex-wrap:wrap;flex-shrink:0;}
.md-hints code{color:var(--border2);background:none;font-size:10px;}

/* PREVIEW PANE */
.pane-preview{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.pane-preview-scroll{flex:1;overflow-y:auto;padding:20px 28px;}
.pane-preview-scroll::-webkit-scrollbar{width:5px;}.pane-preview-scroll::-webkit-scrollbar-thumb{background:var(--border2);}

/* FULL PREVIEW (read-only) */
.pane-full{flex:1;overflow-y:auto;padding:28px 40px;}
.pane-full::-webkit-scrollbar{width:6px;}.pane-full::-webkit-scrollbar-thumb{background:var(--border2);}

/* ‚ïê‚ïê MARKDOWN RENDERED STYLES ‚ïê‚ïê */
.md-out{font-family:var(--serif);font-size:15px;color:var(--text);line-height:1.9;}
.md-out h1{font-family:var(--title);font-size:22px;color:var(--text-bright);letter-spacing:3px;text-transform:uppercase;border-bottom:1px solid var(--border);padding-bottom:8px;margin:20px 0 10px;}
.md-out h2{font-family:var(--title);font-size:16px;color:var(--text-bright);letter-spacing:3px;text-transform:uppercase;margin:20px 0 6px;background:var(--red-dim);border-left:4px solid var(--red);padding:7px 14px;}
.md-out h3{font-family:var(--mono);font-size:13px;color:var(--amber);letter-spacing:3px;text-transform:uppercase;margin:14px 0 6px;padding-left:10px;border-left:2px solid var(--amber-dim);}
.md-out h4{font-family:var(--mono);font-size:12px;color:var(--text-dim);letter-spacing:2px;text-transform:uppercase;margin:10px 0 4px;}
.md-out h5,.md-out h6{font-family:var(--mono);font-size:11px;color:var(--border2);letter-spacing:2px;margin:8px 0 4px;}
.md-out p{margin:8px 0;}
.md-out strong{color:var(--text-bright);}
.md-out em{color:var(--text-dim);font-style:italic;}
.md-out del{color:var(--text-dim);text-decoration:line-through;}
.md-out a{color:var(--amber);text-decoration:none;border-bottom:1px dashed var(--amber-dim);}
.md-out a:hover{color:var(--text-bright);}
.md-out code{font-family:var(--mono);font-size:12px;background:rgba(0,0,0,.5);color:#88cc88;padding:1px 5px;border:1px solid var(--border);}
.md-out pre{background:#000;border:1px solid var(--border);border-left:3px solid var(--red2);padding:14px 18px;overflow-x:auto;margin:12px 0;}
.md-out pre code{background:none;border:none;padding:0;font-size:12px;color:#88cc88;display:block;}
.md-out blockquote{border-left:4px solid var(--border2);margin:12px 0;padding:8px 16px;background:rgba(0,0,0,.3);color:var(--text-dim);font-style:italic;}
.md-out blockquote p{margin:0;}
.md-out ul,.md-out ol{padding-left:24px;margin:8px 0;}
.md-out li{margin:4px 0;}
.md-out li::marker{color:var(--red2);}
.md-out table{width:100%;border-collapse:collapse;margin:12px 0;font-family:var(--mono);font-size:12px;}
.md-out th{background:var(--surface2);border:1px solid var(--border);padding:7px 12px;color:var(--text-bright);letter-spacing:1px;text-align:left;}
.md-out td{border:1px solid var(--border);padding:6px 12px;}
.md-out tr:nth-child(even) td{background:rgba(0,0,0,.2);}
.md-out hr{border:none;border-top:1px solid var(--border);margin:24px 0;position:relative;}
.md-out hr::after{content:'‚¨•  ‚¨•  ‚¨•';position:absolute;left:50%;transform:translateX(-50%);top:-9px;background:var(--bg);padding:0 12px;color:var(--border2);font-size:11px;letter-spacing:6px;}
.md-out img{max-width:100%;border:1px solid var(--border);display:block;margin:12px auto;filter:contrast(1.05) brightness(.9);}
.preview-hint{font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:2px;opacity:.35;text-align:center;padding:40px 20px;line-height:2;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:500;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;backdrop-filter:blur(2px);}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:var(--surface);border:1px solid var(--border2);width:460px;max-width:96vw;transform:scale(.96);transition:transform .2s;box-shadow:0 0 40px rgba(204,17,17,.1),0 0 80px rgba(0,0,0,.8);}
.overlay.open .modal{transform:scale(1);}
.mhd{background:var(--bg2);border-bottom:1px solid var(--border);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;}
.mtitle{font-family:var(--title);font-size:14px;color:var(--red);letter-spacing:3px;text-transform:uppercase;}
.mclose{background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:16px;font-family:var(--mono);}
.mclose:hover{color:var(--red);}
.mbody{padding:22px;}
.mfoot{padding:12px 20px;border-top:1px solid var(--border);background:var(--bg2);display:flex;gap:10px;justify-content:flex-end;}
.mbtn{font-family:var(--mono);font-size:11px;padding:7px 18px;border:1px solid;cursor:pointer;letter-spacing:2px;text-transform:uppercase;background:transparent;transition:all .15s;}
.mbtn.c{border-color:var(--border2);color:var(--text-dim);}
.mbtn.c:hover{color:var(--text);}
.mbtn.ok{border-color:var(--red2);color:var(--red);}
.mbtn.ok:hover{background:var(--red-dim);}
.flabel{font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:3px;text-transform:uppercase;margin-bottom:6px;display:block;}
.frow{margin-bottom:16px;}
.finput{background:var(--bg2);border:1px solid var(--border);color:var(--text-bright);font-family:var(--mono);font-size:14px;padding:8px 12px;outline:none;width:100%;letter-spacing:1px;transition:border-color .15s;}
.finput:focus{border-color:var(--red2);box-shadow:0 0 8px rgba(204,17,17,.2);}
.finput::placeholder{color:var(--text-dim);font-style:italic;}
.fsel{background:var(--bg2);border:1px solid var(--border);color:var(--text-bright);font-family:var(--mono);font-size:12px;padding:8px 12px;outline:none;width:100%;cursor:pointer;}
.fsel option{background:var(--surface2);}
.fsel:focus{border-color:var(--red2);}

/* PASS MODAL */
.pass-disp{font-family:var(--mono);font-size:24px;letter-spacing:8px;color:var(--green);text-align:center;padding:16px;background:#000;border:1px solid var(--green-dim);min-height:60px;display:flex;align-items:center;justify-content:center;}
.pass-err{font-family:var(--mono);font-size:11px;color:var(--red);letter-spacing:2px;text-align:center;min-height:18px;margin-top:6px;}
.pass-err.shake{animation:shake .3s ease;}
@keyframes shake{0%,100%{transform:none}25%{transform:translateX(-6px)}75%{transform:translateX(6px)}}
.keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:4px;margin-top:12px;}

/* IMAGE TABS */
.tab-row{display:flex;gap:4px;margin-bottom:14px;}
.tabBtn{font-family:var(--mono);font-size:10px;padding:5px 12px;border:1px solid var(--border);background:none;color:var(--text-dim);cursor:pointer;letter-spacing:2px;text-transform:uppercase;transition:all .12s;}
.tabBtn.active{border-color:var(--red2);color:var(--red);background:var(--red-dim);}
.tab-p{display:none;}.tab-p.active{display:block;}
.dzone{border:2px dashed var(--border);padding:28px;text-align:center;color:var(--text-dim);font-family:var(--mono);font-size:11px;letter-spacing:2px;cursor:pointer;transition:all .2s;background:var(--bg2);}
.dzone:hover,.dzone.over{border-color:var(--red2);color:var(--red);background:var(--red-dim);}
.dzone input{display:none;}

/* TOAST */
.toast{position:fixed;bottom:20px;right:20px;background:var(--surface2);border:1px solid var(--border2);border-left:4px solid var(--red);font-family:var(--mono);font-size:11px;color:var(--text);padding:10px 16px;letter-spacing:2px;text-transform:uppercase;z-index:9990;transform:translateX(130%);transition:transform .25s;max-width:320px;}
.toast.show{transform:none;}
</style>
</head>
<body>

<!-- BOOT -->
<div id="bootScreen">
  <div class="boot-logo">‚ò£</div>
  <div class="boot-line">SCP FOUNDATION ‚Äî SECURE CONTAIN PROTECT</div>
  <div class="boot-line" style="margin:8px 0;color:#1a1a14;">‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî</div>
  <div class="boot-line ok">[OK] –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–û–¢–û–ö–û–õ–û–í –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò</div>
  <div class="boot-line ok">[OK] –ü–†–û–í–ï–†–ö–ê –¶–ï–õ–û–°–¢–ù–û–°–¢–ò –ë–ê–ó–´ –î–ê–ù–ù–´–•</div>
  <div class="boot-line warn">[!!] –û–ë–ù–ê–†–£–ñ–ï–ù–´ –ê–ù–û–ú–ê–õ–¨–ù–´–ï –û–ë–™–ï–ö–¢–´: –°–í–ï–†–ö–ê...</div>
  <div class="boot-line ok">[OK] –£–†–û–í–ï–ù–¨ –î–û–°–¢–£–ü–ê: –¢–û–õ–¨–ö–û –ß–¢–ï–ù–ò–ï</div>
  <div class="boot-line ok">[OK] –°–û–ï–î–ò–ù–ï–ù–ò–ï –° –°–ï–†–í–ï–†–û–ú –û5</div>
  <div class="boot-line" style="margin-top:16px;color:#2a2a24;font-size:11px;">–î–û–°–¢–£–ü –†–ê–ó–†–ï–®–Å–ù <span class="blink">‚ñà</span></div>
</div>

<!-- HEADER -->
<header>
  <div class="scp-logo">
    <svg width="32" height="32" viewBox="0 0 100 100" fill="none">
      <circle cx="50" cy="50" r="45" stroke="#cc1111" stroke-width="3"/>
      <circle cx="50" cy="50" r="20" stroke="#cc1111" stroke-width="2"/>
      <path d="M50 5 A45 45 0 0 1 89.1 72.5 L64 57.5 A20 20 0 0 0 50 30 Z" fill="#cc1111" opacity=".8"/>
      <path d="M89.1 72.5 A45 45 0 0 1 10.9 72.5 L36 57.5 A20 20 0 0 0 64 57.5 Z" fill="#cc1111" opacity=".8"/>
      <path d="M10.9 72.5 A45 45 0 0 1 50 5 L50 30 A20 20 0 0 0 36 57.5 Z" fill="#cc1111" opacity=".8"/>
    </svg>
    SCP FOUNDATION
  </div>
  <div class="header-mid">
    –ë–ê–ó–ê –î–ê–ù–ù–´–• –ê–ù–û–ú–ê–õ–¨–ù–´–• –û–ë–™–ï–ö–¢–û–í<br>
    <span style="color:var(--border2);">CLEARANCE REQUIRED /// UNAUTHORIZED ACCESS PROHIBITED</span>
  </div>
  <div class="header-right">
    <div class="access-badge ro" id="syncBadge" style="cursor:pointer;" onclick="openCloudSetup()" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–ª–∞—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏">‚óè –õ–û–ö–ê–õ–¨–ù–û</div>
    <button class="hbtn" onclick="openCloudSetup()" title="–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±–ª–∞—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä">‚òÅ –û–ë–õ–ê–ö–û</button>
    <button class="hbtn" onclick="exportDB()" title="–°–∫–∞—á–∞—Ç—å –±–∞–∑—É –∫–∞–∫ .json —Ñ–∞–π–ª">‚¨á –≠–ö–°–ü–û–†–¢</button>
    <label class="hbtn" title="–ó–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–∑—É –∏–∑ .json —Ñ–∞–π–ª–∞" style="cursor:pointer;">
      ‚¨Ü –ò–ú–ü–û–†–¢
      <input type="file" id="importFile" accept=".json" onchange="importDB(event)" style="display:none;">
    </label>
    <div style="width:1px;height:20px;background:var(--border2);margin:0 4px;"></div>
    <div class="access-badge ro" id="accessBadge">‚óè –¢–û–õ–¨–ö–û –ß–¢–ï–ù–ò–ï</div>
    <button class="hbtn" onclick="openAuthModal()" id="authBtn">‚¨° –î–û–°–¢–£–ü –ü–ï–†–°–û–ù–ê–õ–ê</button>
    <button class="hbtn danger" onclick="logout()" id="logoutBtn" style="display:none;">‚¨° –í–´–•–û–î</button>
  </div>
</header>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sb-head">
      <div class="sb-label">–û–ë–™–ï–ö–¢–´ –ë–ê–ó–´</div>
      <input type="text" class="sb-search" placeholder="–ü–û–ò–°–ö –û–ë–™–ï–ö–¢–ê..." oninput="filterEntities(this.value)">
    </div>
    <div class="entity-list" id="entityList"></div>
    <div class="sb-foot">
      <button class="sbtn danger" id="addEntityBtn" onclick="openNewEntityModal()" style="display:none;">‚äï –°–û–ó–î–ê–¢–¨ –û–ë–™–ï–ö–¢</button>
      <div id="roNote" style="font-family:var(--mono);font-size:9px;color:var(--text-dim);letter-spacing:1px;text-align:center;line-height:1.6;">–£–†–û–í–ï–ù–¨ –î–û–°–¢–£–ü–ê: –¢–û–õ–¨–ö–û –ß–¢–ï–ù–ò–ï<br>–î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ‚Äî –ê–í–¢–û–†–ò–ó–£–ô–¢–ï–°–¨</div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main" id="mainContent">
    <div class="empty-state">
      <div class="sym">‚ò£</div>
      <h2>–û–ë–™–ï–ö–¢ –ù–ï –í–´–ë–†–ê–ù</h2>
      <p>–í–´–ë–ï–†–ò–¢–ï –û–ë–™–ï–ö–¢ –ò–ó –°–ü–ò–°–ö–ê –°–õ–ï–í–ê<br><br>–î–õ–Ø –°–û–ó–î–ê–ù–ò–Ø –û–ë–™–ï–ö–¢–û–í –¢–†–ï–ë–£–ï–¢–°–Ø –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –£–†–û–í–ù–Ø –û5</p>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="overlay" id="authOverlay">
  <div class="modal" style="width:350px;">
    <div class="mhd"><div class="mtitle">‚¨° –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ü–ï–†–°–û–ù–ê–õ–ê</div><button class="mclose" onclick="closeModal('authOverlay')">‚úï</button></div>
    <div class="mbody">
      <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:2px;text-align:center;margin-bottom:18px;line-height:1.8;">–í–í–ï–î–ò–¢–ï –ö–û–î –î–û–°–¢–£–ü–ê<br><span style="color:var(--red-dim);">–ù–ï–°–ê–ù–ö–¶–ò–û–ù–ò–†–û–í–ê–ù–ù–´–ô –î–û–°–¢–£–ü –§–ò–ö–°–ò–†–£–ï–¢–°–Ø</span></div>
      <div class="pass-disp" id="passDisplay"><span class="blink" style="color:var(--green-dim);">‚ñà</span></div>
      <div class="keypad" id="keypad"></div>
      <div class="pass-err" id="passError"></div>
    </div>
    <div class="mfoot">
      <button class="mbtn c" onclick="clearPass()">–°–ë–†–û–°</button>
      <button class="mbtn ok" onclick="attemptAuth()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
    </div>
  </div>
</div>

<!-- NEW ENTITY MODAL -->
<div class="overlay" id="newEntityOverlay">
  <div class="modal">
    <div class="mhd"><div class="mtitle">‚äï –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø –ù–û–í–û–ì–û –û–ë–™–ï–ö–¢–ê</div><button class="mclose" onclick="closeModal('newEntityOverlay')">‚úï</button></div>
    <div class="mbody">
      <div class="frow"><label class="flabel">–û–ë–û–ó–ù–ê–ß–ï–ù–ò–ï –û–ë–™–ï–ö–¢–ê</label><input type="text" class="finput" id="newName" placeholder="–ò–ú–Ø / –ù–ê–ó–í–ê–ù–ò–ï..."></div>
      <div class="frow">
        <label class="flabel">–ö–õ–ê–°–° –£–ì–†–û–ó–´</label>
        <select class="fsel" id="newThreat">
          <option value="SAFE">SAFE ‚Äî –ë–ï–ó–û–ü–ê–°–ù–´–ô</option>
          <option value="EUCLID" selected>EUCLID ‚Äî –ï–í–ö–õ–ò–î</option>
          <option value="KETER">KETER ‚Äî –ö–ï–¢–ï–† ‚ö†</option>
          <option value="THAUMIEL">THAUMIEL ‚Äî –¢–ê–£–ú–ò–≠–õ–¨</option>
          <option value="NEUTRALIZED">NEUTRALIZED ‚Äî –ù–ï–ô–¢–†–ê–õ–ò–ó–û–í–ê–ù</option>
        </select>
      </div>
      <div class="frow"><label class="flabel">–û–¢–í–ï–¢–°–¢–í–ï–ù–ù–´–ô –ò–°–°–õ–ï–î–û–í–ê–¢–ï–õ–¨</label><input type="text" class="finput" id="newResearcher" placeholder="–î-—Ä ..."></div>
      <div class="frow"><label class="flabel">–ú–ï–°–¢–û –°–û–î–ï–†–ñ–ê–ù–ò–Ø</label><input type="text" class="finput" id="newLocation" placeholder="–ó–û–ù–ê-19, –°–ï–ö–¢–û–†-–ë..."></div>
    </div>
    <div class="mfoot">
      <button class="mbtn c" onclick="closeModal('newEntityOverlay')">–û–¢–ú–ï–ù–ê</button>
      <button class="mbtn ok" onclick="createEntity()">–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨</button>
    </div>
  </div>
</div>

<!-- IMAGE MODAL -->
<div class="overlay" id="imageOverlay">
  <div class="modal">
    <div class="mhd"><div class="mtitle">‚¨õ –í–õ–û–ñ–ò–¢–¨ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï / GIF</div><button class="mclose" onclick="closeModal('imageOverlay')">‚úï</button></div>
    <div class="mbody">
      <div class="tab-row">
        <button class="tabBtn active" onclick="switchImgTab('url')">–ü–û –°–°–´–õ–ö–ï</button>
        <button class="tabBtn" onclick="switchImgTab('upload')">–ó–ê–ì–†–£–ó–ò–¢–¨</button>
      </div>
      <div class="tab-p active" id="imgtab-url">
        <div class="frow"><label class="flabel">URL –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø / GIF</label><input type="url" class="finput" id="imgUrl" placeholder="https://..."></div>
        <div style="font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:1px;">.JPG .PNG .GIF .WEBP ‚Äî GIPHY / TENOR</div>
      </div>
      <div class="tab-p" id="imgtab-upload">
        <div class="dzone" id="dropZone" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept="image/*,.gif" onchange="handleImgFile(event)">
          <div style="font-size:28px;margin-bottom:8px;">‚¨õ</div>
          –ù–ê–ñ–ú–ò–¢–ï –ò–õ–ò –ü–ï–†–ï–¢–ê–©–ò–¢–ï –§–ê–ô–õ
        </div>
      </div>
      <div class="frow" style="margin-top:14px;"><label class="flabel">–ü–û–î–ü–ò–°–¨ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label><input type="text" class="finput" id="imgCaption" placeholder="–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è –æ–±—ä–µ–∫—Ç–∞..."></div>
    </div>
    <div class="mfoot">
      <button class="mbtn c" onclick="closeModal('imageOverlay')">–û–¢–ú–ï–ù–ê</button>
      <button class="mbtn ok" onclick="insertImageMd()">–í–°–¢–ê–í–ò–¢–¨ –í –¢–ï–ö–°–¢</button>
    </div>
  </div>
</div>

<!-- CLOUD SETUP MODAL -->
<div class="overlay" id="cloudOverlay">
  <div class="modal" style="width:500px;">
    <div class="mhd">
      <div class="mtitle">‚òÅ –ù–ê–°–¢–†–û–ô–ö–ê –û–ë–õ–ê–ß–ù–û–ì–û –°–ï–†–í–ï–†–ê</div>
      <button class="mclose" onclick="closeModal('cloudOverlay')">‚úï</button>
    </div>
    <div class="mbody">
      <div style="font-family:var(--mono);font-size:11px;color:var(--text-dim);letter-spacing:1px;line-height:1.9;margin-bottom:20px;border-left:3px solid var(--red2);padding-left:12px;">
        –°—Ç–∞—Ç—å–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ <b style="color:var(--text);">jsonbin.io</b> ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –ª–∏–º–∏—Ç–æ–≤ –Ω–∞ —á—Ç–µ–Ω–∏–µ.<br>
        –¢–≤–æ–π –¥—Ä—É–≥ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ç–æ—Ç –∂–µ HTML —Ñ–∞–π–ª ‚Äî –∏ –≤–∏–¥–∏—Ç –≤—Å–µ —Å—Ç–∞—Ç—å–∏.<br><br>
        <b style="color:var(--amber);">–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å:</b><br>
        1. –ó–∞–π–¥–∏ –Ω–∞ <a href="https://jsonbin.io" target="_blank" style="color:var(--amber);">jsonbin.io</a> ‚Üí –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è<br>
        2. –ü—Ä–æ—Ñ–∏–ª—å ‚Üí API Keys ‚Üí —Å–∫–æ–ø–∏—Ä—É–π <b style="color:var(--text);">Master Key</b><br>
        3. –í—Å—Ç–∞–≤—å –∫–ª—é—á –Ω–∏–∂–µ –∏ –Ω–∞–∂–º–∏ ¬´–ü–û–î–ö–õ–Æ–ß–ò–¢–¨¬ª<br>
        4. ID –∫–æ—Ä–∑–∏–Ω—ã —Å–æ–∑–¥–∞—Å—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
      </div>
      <div class="frow">
        <label class="flabel">API –ö–õ–Æ–ß (Master Key —Å jsonbin.io)</label>
        <input type="text" class="finput" id="cloudKeyInput" placeholder="$2a$10$...">
      </div>
      <div class="frow">
        <label class="flabel">ID –ö–û–†–ó–ò–ù–´ (–∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)</label>
        <input type="text" class="finput" id="cloudBinInput" placeholder="64abc123... (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∫–æ—Ä–∑–∏–Ω—ã)">
      </div>
      <div id="cloudStatusInfo" style="font-family:var(--mono);font-size:10px;color:var(--text-dim);letter-spacing:1px;margin-top:4px;"></div>
    </div>
    <div class="mfoot">
      <button class="mbtn c" onclick="clearCloudConfig()">–û–¢–ö–õ–Æ–ß–ò–¢–¨ –û–ë–õ–ê–ö–û</button>
      <button class="mbtn c" onclick="closeModal('cloudOverlay')">–û–¢–ú–ï–ù–ê</button>
      <button class="mbtn ok" onclick="saveCloudConfig()">–ü–û–î–ö–õ–Æ–ß–ò–¢–¨ ‚òÅ</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// –ö–û–ù–§–ò–ì –û–ë–õ–ê–ö–ê ‚Äî –∑–∞–ø–æ–ª–Ω–∏ –æ–¥–∏–Ω —Ä–∞–∑
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const JSONBIN_KEY = localStorage.getItem('scp_jbkey') || '';
const ADMIN_PASS = 'root';

marked.setOptions({ breaks: true, gfm: true });

let isAdmin = false;
let entities = JSON.parse(localStorage.getItem('scp_db') || '[]');
let activeId = null;
let passBuffer = '';
let pendingImg = null;
let scpBase = 7000 + Math.floor(Math.random() * 2000);
let cloudBinId = localStorage.getItem('scp_bin_id') || '';

window.addEventListener('load', () => {
  buildKeypad();
  if (JSONBIN_KEY && cloudBinId) {
    cloudLoad();
    updateSyncBadge('syncing');
  } else {
    renderList();
    if (entities.length) selectEntity(entities[0].id);
    updateSyncBadge('local');
  }
  setTimeout(() => { document.getElementById('bootScreen').style.display = 'none'; }, 3100);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildKeypad() {
  const kp = document.getElementById('keypad');
  ['7','8','9','4','5','6','1','2','3','‚å´','0','‚Üµ'].forEach(k => {
    const b = document.createElement('button');
    b.textContent = k;
    b.className = 'mbtn c';
    Object.assign(b.style, { fontSize:'18px', padding:'12px', letterSpacing:'0', fontFamily:'var(--mono)' });
    b.onclick = () => kpPress(k);
    kp.appendChild(b);
  });
}

function kpPress(k) {
  if (k === '‚å´') passBuffer = passBuffer.slice(0,-1);
  else if (k === '‚Üµ') { attemptAuth(); return; }
  else if (passBuffer.length < 20) passBuffer += k;
  refreshPassDisplay();
  document.getElementById('passError').textContent = '';
}

function refreshPassDisplay() {
  const d = document.getElementById('passDisplay');
  d.innerHTML = passBuffer ? '‚óè'.repeat(passBuffer.length) : '<span class="blink" style="color:var(--green-dim)">‚ñà</span>';
}

function clearPass() { passBuffer = ''; refreshPassDisplay(); document.getElementById('passError').textContent = ''; }
function openAuthModal() { clearPass(); openOverlay('authOverlay'); }

function attemptAuth() {
  if (passBuffer !== ADMIN_PASS) {
    const e = document.getElementById('passError');
    e.textContent = '‚ö† –ö–û–î –î–û–°–¢–£–ü–ê –ù–ï–í–ï–†–ï–ù ‚Äî –ò–ù–¶–ò–î–ï–ù–¢ –ó–ê–§–ò–ö–°–ò–†–û–í–ê–ù';
    e.classList.remove('shake'); void e.offsetWidth; e.classList.add('shake');
    clearPass(); return;
  }
  isAdmin = true;
  closeModal('authOverlay');
  document.getElementById('accessBadge').textContent = '‚óè –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–û–† –û5';
  document.getElementById('accessBadge').className = 'access-badge adm';
  document.getElementById('authBtn').style.display = 'none';
  document.getElementById('logoutBtn').style.display = 'inline-flex';
  document.getElementById('addEntityBtn').style.display = 'flex';
  document.getElementById('roNote').style.display = 'none';
  toast('–î–û–°–¢–£–ü –†–ê–ó–†–ï–®–Å–ù // –£–†–û–í–ï–ù–¨ –û5');
  if (activeId) renderDoc();
}

function logout() {
  isAdmin = false;
  document.getElementById('accessBadge').textContent = '‚óè –¢–û–õ–¨–ö–û –ß–¢–ï–ù–ò–ï';
  document.getElementById('accessBadge').className = 'access-badge ro';
  document.getElementById('authBtn').style.display = 'inline-flex';
  document.getElementById('logoutBtn').style.display = 'none';
  document.getElementById('addEntityBtn').style.display = 'none';
  document.getElementById('roNote').style.display = 'block';
  toast('–°–ï–°–°–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê');
  if (activeId) renderDoc();
}

document.addEventListener('keydown', ev => {
  if (!document.getElementById('authOverlay').classList.contains('open')) return;
  if (/^[a-zA-Z0-9]$/.test(ev.key)) { if (passBuffer.length < 20) { passBuffer += ev.key; refreshPassDisplay(); document.getElementById('passError').textContent=''; } }
  else if (ev.key === 'Backspace') kpPress('‚å´');
  else if (ev.key === 'Enter') kpPress('‚Üµ');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ENTITY LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderList(q = '') {
  const list = document.getElementById('entityList');
  list.innerHTML = '';
  const arr = q ? entities.filter(e => e.name.toLowerCase().includes(q.toLowerCase()) || e.number.includes(q)) : entities;
  arr.forEach(e => {
    const d = document.createElement('div');
    d.className = 'ent' + (e.id === activeId ? ' active' : '');
    d.onclick = () => selectEntity(e.id);
    d.innerHTML = `
      <div class="ent-num">SCP-${e.number}</div>
      <div class="ent-name">${esc(e.name)}</div>
      <span class="tbadge ${e.threat}">${e.threat}</span>
      ${isAdmin ? `<button class="ent-del" onclick="deleteEntity(event,'${e.id}')">‚úï</button>` : ''}
    `;
    list.appendChild(d);
  });
}

function filterEntities(q) { renderList(q); }

function selectEntity(id) {
  if (activeId && isAdmin) saveCurrent();
  activeId = id;
  renderList();
  renderDoc();
}

function openNewEntityModal() {
  if (!isAdmin) { toast('–î–û–°–¢–£–ü –ó–ê–ü–†–ï–©–Å–ù'); return; }
  ['newName','newResearcher','newLocation'].forEach(i => document.getElementById(i).value = '');
  openOverlay('newEntityOverlay');
}

function createEntity() {
  const name = document.getElementById('newName').value.trim();
  if (!name) { toast('–í–í–ï–î–ò–¢–ï –û–ë–û–ó–ù–ê–ß–ï–ù–ò–ï –û–ë–™–ï–ö–¢–ê'); return; }
  scpBase++;
  const entity = {
    id: 'e' + Date.now(),
    number: String(scpBase),
    name,
    threat: document.getElementById('newThreat').value,
    researcher: document.getElementById('newResearcher').value.trim() || '–ó–ê–°–ï–ö–†–ï–ß–ï–ù–û',
    location: document.getElementById('newLocation').value.trim() || '–ó–ê–°–ï–ö–†–ï–ß–ï–ù–û',
    markdown: `# –ü—Ä–æ—Ü–µ–¥—É—Ä—ã —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è\n\n–û–±—ä–µ–∫—Ç SCP-${scpBase} –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å—Å—è –≤...\n\n## –û–ø–∏—Å–∞–Ω–∏–µ\n\nSCP-${scpBase} –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å–æ–±–æ–π...\n\n## –ò—Å—Ç–æ—Ä–∏—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è\n\n> ¬´–≠—Ç–æ –±—ã–ª–æ –Ω–µ—á—Ç–æ, —á–µ–≥–æ –º—ã –Ω–µ –º–æ–≥–ª–∏ –æ–±—ä—è—Å–Ω–∏—Ç—å¬ª ‚Äî –î-—Ä ...\n\n## –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏\n\n- –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å 1\n- –°–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å 2\n\n---\n\n**–£—Ä–æ–≤–µ–Ω—å —Å–µ–∫—Ä–µ—Ç–Ω–æ—Å—Ç–∏:** ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà\n`
  };
  entities.push(entity);
  closeModal('newEntityOverlay');
  saveAll();
  renderList();
  selectEntity(entity.id);
}

function deleteEntity(ev, id) {
  ev.stopPropagation();
  if (!confirm('–£–î–ê–õ–ò–¢–¨ –û–ë–™–ï–ö–¢? –î–ï–ô–°–¢–í–ò–ï –ù–ï–û–ë–†–ê–¢–ò–ú–û.')) return;
  entities = entities.filter(x => x.id !== id);
  if (activeId === id) {
    activeId = null;
    document.getElementById('mainContent').innerHTML = `<div class="empty-state"><div class="sym">‚ò£</div><h2>–û–ë–™–ï–ö–¢ –£–î–ê–õ–Å–ù</h2><p>–ó–ê–ü–ò–°–¨ –£–ù–ò–ß–¢–û–ñ–ï–ù–ê –ò–ó –ë–ê–ó–´ –î–ê–ù–ù–´–•</p></div>`;
  }
  saveAll(); renderList();
}

function getEntity(id) { return entities.find(e => e.id === id); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DOC RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDoc() {
  const entity = getEntity(activeId);
  if (!entity) return;
  const main = document.getElementById('mainContent');
  main.innerHTML = '';

  const view = document.createElement('div');
  view.className = 'doc-view';

  if (!isAdmin) {
    const banner = document.createElement('div');
    banner.className = 'ro-banner';
    banner.textContent = '‚ö† –†–ï–ñ–ò–ú –¢–û–õ–¨–ö–û –î–õ–Ø –ß–¢–ï–ù–ò–Ø // –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–ü–†–ï–©–ï–ù–û // –ù–ï–°–ê–ù–ö–¶–ò–û–ù–ò–†–û–í–ê–ù–ù–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï –î–ê–ù–ù–´–• –Ø–í–õ–Ø–ï–¢–°–Ø –ù–ê–†–£–®–ï–ù–ò–ï–ú –ü–†–û–¢–û–ö–û–õ–ê';
    view.appendChild(banner);
  }

  // doc header
  const hdr = document.createElement('div');
  hdr.className = 'doc-header';
  hdr.innerHTML = buildHeader(entity);
  view.appendChild(hdr);

  // panes
  const panes = document.createElement('div');
  panes.className = 'panes';

  if (isAdmin) {
    // Write pane
    const wp = document.createElement('div');
    wp.className = 'pane-write';
    wp.innerHTML = `
      <div class="pane-label"><span>MARKDOWN ‚Äî –†–ï–î–ê–ö–¢–û–†</span><span style="color:var(--green-dim);">‚óè –†–ï–ñ–ò–ú –ó–ê–ü–ò–°–ò</span></div>
      <div class="md-bar" id="mdBar">${buildMdBarHtml()}</div>
      <textarea class="md-ta" id="mdTa" placeholder="# –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–∑–¥–µ–ª–∞&#10;&#10;–ù–∞—á–Ω–∏—Ç–µ –ø–∏—Å–∞—Ç—å —Å—Ç–∞—Ç—å—é –Ω–∞ Markdown...&#10;&#10;## –†–∞–∑–¥–µ–ª&#10;&#10;**–ñ–∏—Ä–Ω—ã–π**, *–∫—É—Ä—Å–∏–≤*, \`–∫–æ–¥\`, ~~–∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π~~&#10;&#10;> –¶–∏—Ç–∞—Ç–∞ –∏–ª–∏ –ø–æ–∫–∞–∑–∞–Ω–∏—è&#10;&#10;- –°–ø–∏—Å–æ–∫&#10;- –≠–ª–µ–º–µ–Ω—Ç–æ–≤">${esc(entity.markdown || '')}</textarea>
      <div class="md-hints">
        <code># H1</code><code>## H2</code><code>### H3</code>
        <code>**–∂–∏—Ä–Ω—ã–π**</code><code>*–∫—É—Ä—Å–∏–≤*</code><code>~~–∑–∞—á—ë—Ä–∫~~</code><code>\`–∫–æ–¥\`</code>
        <code>> —Ü–∏—Ç–∞—Ç–∞</code><code>- —Å–ø–∏—Å–æ–∫</code><code>---</code><code>![alt](url)</code><code>| —Ç–∞–±–ª–∏—Ü–∞ |</code>
      </div>
    `;
    panes.appendChild(wp);

    // Preview pane
    const pp = document.createElement('div');
    pp.className = 'pane-preview';
    pp.innerHTML = `<div class="pane-label"><span>–ü–†–ï–î–ü–†–û–°–ú–û–¢–†</span><span style="color:var(--amber-dim);">‚óâ LIVE</span></div>`;
    const scroll = document.createElement('div');
    scroll.className = 'pane-preview-scroll';
    const out = document.createElement('div');
    out.className = 'md-out';
    out.id = 'mdOut';
    scroll.appendChild(out);
    pp.appendChild(scroll);
    panes.appendChild(pp);

    view.appendChild(panes);
    main.appendChild(view);

    // setup textarea events
    const ta = document.getElementById('mdTa');
    ta.addEventListener('input', () => {
      entity.markdown = ta.value;
      renderPreview(ta.value);
    });
    ta.addEventListener('keydown', ev => {
      if (ev.key === 'Tab') {
        ev.preventDefault();
        const s = ta.selectionStart;
        ta.setRangeText('  ', s, s, 'end');
        entity.markdown = ta.value;
        renderPreview(ta.value);
      }
    });

    renderPreview(entity.markdown || '');

  } else {
    // Read-only full preview
    const fp = document.createElement('div');
    fp.className = 'pane-full';
    const out = document.createElement('div');
    out.className = 'md-out';
    out.innerHTML = entity.markdown
      ? marked.parse(entity.markdown)
      : '<div class="preview-hint">[ –î–û–ö–£–ú–ï–ù–¢ –ü–£–°–¢ ]<br>–°–û–î–ï–†–ñ–ò–ú–û–ï –û–¢–°–£–¢–°–¢–í–£–ï–¢</div>';
    fp.appendChild(out);
    panes.appendChild(fp);
    view.appendChild(panes);
    main.appendChild(view);
  }
}

function renderPreview(md) {
  const out = document.getElementById('mdOut');
  if (!out) return;
  out.innerHTML = md ? marked.parse(md) : '<div class="preview-hint">–ù–ê–ß–ù–ò–¢–ï –í–í–û–î–ò–¢–¨ –¢–ï–ö–°–¢ –°–õ–ï–í–ê...</div>';
}

function buildHeader(entity) {
  const e = isAdmin;
  const statusColor = entity.threat==='NEUTRALIZED' ? '#666' : entity.threat==='KETER' ? 'var(--red)' : 'var(--green)';
  const statusText = entity.threat==='NEUTRALIZED' ? '–ù–ï–ô–¢–†–ê–õ–ò–ó–û–í–ê–ù' : entity.threat==='KETER' ? '‚ö† –ê–ö–¢–ò–í–ï–ù' : '–ü–û–î –ö–û–ù–¢–†–û–õ–ï–ú';
  return `
  <div class="doc-id-corner">DOC #${entity.number}-${Date.now().toString(36).toUpperCase().slice(-4)}</div>
  <div class="dh-top">
    <div class="dh-logo">
      <svg width="50" height="50" viewBox="0 0 100 100" fill="none">
        <circle cx="50" cy="50" r="45" stroke="#cc1111" stroke-width="3"/>
        <circle cx="50" cy="50" r="20" stroke="#cc1111" stroke-width="2"/>
        <path d="M50 5 A45 45 0 0 1 89.1 72.5 L64 57.5 A20 20 0 0 0 50 30 Z" fill="#cc1111" opacity=".8"/>
        <path d="M89.1 72.5 A45 45 0 0 1 10.9 72.5 L36 57.5 A20 20 0 0 0 64 57.5 Z" fill="#cc1111" opacity=".8"/>
        <path d="M10.9 72.5 A45 45 0 0 1 50 5 L50 30 A20 20 0 0 0 36 57.5 Z" fill="#cc1111" opacity=".8"/>
      </svg>
    </div>
    <div class="dh-info">
      <div class="dh-num">–û–ë–™–ï–ö–¢ ‚Ññ: SCP-${entity.number}</div>
      ${e ? `<input class="dh-name-input" type="text" value="${esc(entity.name)}" oninput="updateMeta('name',this.value)">` : `<div class="dh-name">${esc(entity.name)}</div>`}
    </div>
    <div class="dh-stamps">
      <div class="stamp cl">–ó–ê–°–ï–ö–†–ï–ß–ï–ù–û</div>
      <div class="stamp re">–û–ì–†–ê–ù–ò–ß–ï–ù–ù–´–ô –î–û–°–¢–£–ü</div>
    </div>
  </div>
  <div class="dh-meta">
    <div class="dh-cell">
      <div class="dh-cell-label">–ö–õ–ê–°–° –£–ì–†–û–ó–´</div>
      <div class="dh-cell-val">
        ${e ? `<select class="meta-sel" onchange="updateMeta('threat',this.value)">${['SAFE','EUCLID','KETER','THAUMIEL','NEUTRALIZED'].map(t=>`<option value="${t}" ${entity.threat===t?'selected':''}>${t}</option>`).join('')}</select>` : `<span class="tbadge ${entity.threat}">${entity.threat}</span>`}
      </div>
    </div>
    <div class="dh-cell">
      <div class="dh-cell-label">–ò–°–°–õ–ï–î–û–í–ê–¢–ï–õ–¨</div>
      <div class="dh-cell-val">${e ? `<input class="meta-inp" type="text" value="${esc(entity.researcher||'')}" oninput="updateMeta('researcher',this.value)">` : esc(entity.researcher||'–ó–ê–°–ï–ö–†–ï–ß–ï–ù–û')}</div>
    </div>
    <div class="dh-cell">
      <div class="dh-cell-label">–ú–ï–°–¢–û –°–û–î–ï–†–ñ–ê–ù–ò–Ø</div>
      <div class="dh-cell-val">${e ? `<input class="meta-inp" type="text" value="${esc(entity.location||'')}" oninput="updateMeta('location',this.value)">` : esc(entity.location||'–ó–ê–°–ï–ö–†–ï–ß–ï–ù–û')}</div>
    </div>
    <div class="dh-cell">
      <div class="dh-cell-label">–°–¢–ê–¢–£–°</div>
      <div class="dh-cell-val" style="color:${statusColor};">${statusText}</div>
    </div>
  </div>`;
}

function updateMeta(field, value) {
  const entity = getEntity(activeId);
  if (!entity) return;
  entity[field] = value;
  renderList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKDOWN TOOLBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildMdBarHtml() {
  const items = [
    ['H1','wrapLine("# ","")'],['H2','wrapLine("## ","")'],['H3','wrapLine("### ","")'],
    ['SEP',null],
    ['<b>B</b>','wrapSel("**","**")'],['<i>I</i>','wrapSel("*","*")'],['<s>S</s>','wrapSel("~~","~~")'],
    ['`code`','wrapSel("`","`")'],['``` –±–ª–æ–∫','wrapSel("```\\n","\\n```")'],
    ['SEP',null],
    ['‚ùù —Ü–∏—Ç–∞—Ç–∞','wrapLine("> ","")'],
    ['‚ö† –≤–Ω–∏–º–∞–Ω–∏–µ','wrapLine("> ‚ö† **–í–ù–ò–ú–ê–ù–ò–ï:** ","")'],
    ['‚Ä¢ —Å–ø–∏—Å–æ–∫','wrapLine("- ","")'],['1. –Ω—É–º–µ—Ä.','wrapLine("1. ","")'],
    ['SEP',null],
    ['‚äû —Ç–∞–±–ª–∏—Ü–∞','insertTpl("| –ö–æ–ª–æ–Ω–∫–∞ 1 | –ö–æ–ª–æ–Ω–∫–∞ 2 | –ö–æ–ª–æ–Ω–∫–∞ 3 |\\n|-----------|-----------|----------|\\n| –î–∞–Ω–Ω—ã–µ    | –î–∞–Ω–Ω—ã–µ    | –î–∞–Ω–Ω—ã–µ   |\\n")'],
    ['‚îÄ‚îÄ‚îÄ –ª–∏–Ω–∏—è','insertTpl("\\n---\\n")'],
    ['SEP',null],
    ['üñº –∫–∞—Ä—Ç–∏–Ω–∫–∞','openImgModal()'],
    ['üîó —Å—Å—ã–ª–∫–∞','wrapSel("[","](url)")'],
  ];
  return items.map(([label, action]) => {
    if (label === 'SEP') return `<div class="mdb-sep"></div>`;
    return `<button class="mdb" onclick="${action}">${label}</button>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MARKDOWN HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getTA() { return document.getElementById('mdTa'); }

function wrapSel(before, after) {
  const ta = getTA(); if (!ta) return;
  const s = ta.selectionStart, e = ta.selectionEnd;
  const sel = ta.value.slice(s, e) || '—Ç–µ–∫—Å—Ç';
  ta.setRangeText(before + sel + after, s, e, 'select');
  ta.focus();
  syncMd();
}

function wrapLine(prefix) {
  const ta = getTA(); if (!ta) return;
  const s = ta.selectionStart;
  const ls = ta.value.lastIndexOf('\n', s - 1) + 1;
  const le = ta.value.indexOf('\n', s);
  const end = le === -1 ? ta.value.length : le;
  ta.setRangeText(prefix + ta.value.slice(ls, end), ls, end, 'end');
  ta.focus();
  syncMd();
}

function insertTpl(tpl) {
  const ta = getTA(); if (!ta) return;
  const s = ta.selectionStart;
  ta.setRangeText(tpl, s, s, 'end');
  ta.focus();
  syncMd();
}

function syncMd() {
  const ta = getTA(); if (!ta) return;
  const entity = getEntity(activeId);
  if (entity) entity.markdown = ta.value;
  renderPreview(ta.value);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// IMAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openImgModal() {
  pendingImg = null;
  document.getElementById('imgUrl').value = '';
  document.getElementById('imgCaption').value = '';
  document.getElementById('dropZone').innerHTML = `<input type="file" id="fileInput" accept="image/*,.gif" onchange="handleImgFile(event)"><div style="font-size:28px;margin-bottom:8px;">‚¨õ</div>–ù–ê–ñ–ú–ò–¢–ï –ò–õ–ò –ü–ï–†–ï–¢–ê–©–ò–¢–ï –§–ê–ô–õ`;
  switchImgTab('url');
  openOverlay('imageOverlay');
  const dz = document.getElementById('dropZone');
  dz.ondragover = ev => { ev.preventDefault(); dz.classList.add('over'); };
  dz.ondragleave = () => dz.classList.remove('over');
  dz.ondrop = ev => { ev.preventDefault(); dz.classList.remove('over'); handleImgFiles(ev.dataTransfer.files); };
}

function handleImgFile(ev) { handleImgFiles(ev.target.files); }

function handleImgFiles(files) {
  if (!files || !files[0]) return;
  const reader = new FileReader();
  reader.onload = ev => {
    pendingImg = ev.target.result;
    document.getElementById('dropZone').innerHTML = `<img src="${pendingImg}" style="max-height:90px;max-width:100%;border:1px solid var(--border);">`;
  };
  reader.readAsDataURL(files[0]);
}

function switchImgTab(tab) {
  document.querySelectorAll('.tabBtn').forEach((b, i) => b.classList.toggle('active', (i===0&&tab==='url')||(i===1&&tab==='upload')));
  document.getElementById('imgtab-url').classList.toggle('active', tab==='url');
  document.getElementById('imgtab-upload').classList.toggle('active', tab==='upload');
}

function insertImageMd() {
  const src = pendingImg || document.getElementById('imgUrl').value.trim();
  if (!src) { toast('–£–ö–ê–ñ–ò–¢–ï –ò–°–¢–û–ß–ù–ò–ö –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø'); return; }
  const caption = document.getElementById('imgCaption').value.trim() || '–ú–∞—Ç–µ—Ä–∏–∞–ª –æ–±—ä–µ–∫—Ç–∞';
  closeModal('imageOverlay');
  insertTpl(`\n![${caption}](${src})\n`);
  toast('–ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï –í–°–¢–ê–í–õ–ï–ù–û');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SAVE & CLOUD SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveCurrent() {
  const entity = getEntity(activeId);
  if (!entity) return;
  const ta = document.getElementById('mdTa');
  if (ta) entity.markdown = ta.value;
  const ni = document.querySelector('.dh-name-input');
  if (ni) entity.name = ni.value;
}

function saveAll() {
  saveCurrent();
  localStorage.setItem('scp_db', JSON.stringify(entities));
  if (JSONBIN_KEY && cloudBinId) {
    cloudSave();
  } else {
    toast('–î–ê–ù–ù–´–ï –°–û–•–†–ê–ù–ï–ù–´ –õ–û–ö–ê–õ–¨–ù–û');
  }
}

// ‚îÄ‚îÄ‚îÄ CLOUD: –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ‚îÄ‚îÄ‚îÄ
async function cloudLoad() {
  updateSyncBadge('syncing');
  try {
    const r = await fetch(`https://api.jsonbin.io/v3/b/${cloudBinId}/latest`, {
      headers: { 'X-Master-Key': JSONBIN_KEY, 'X-Bin-Meta': 'false' }
    });
    if (!r.ok) throw new Error(r.status);
    const data = await r.json();
    if (Array.isArray(data)) {
      entities = data;
      localStorage.setItem('scp_db', JSON.stringify(entities));
    }
    updateSyncBadge('cloud');
  } catch(e) {
    updateSyncBadge('error');
    toast('–û–®–ò–ë–ö–ê –ó–ê–ì–†–£–ó–ö–ò –° –°–ï–†–í–ï–†–ê: ' + e.message);
  }
  renderList();
  if (entities.length) selectEntity(entities[0].id);
}

// ‚îÄ‚îÄ‚îÄ CLOUD: —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ ‚îÄ‚îÄ‚îÄ
async function cloudSave() {
  updateSyncBadge('syncing');
  try {
    let url, method;
    if (cloudBinId) {
      url = `https://api.jsonbin.io/v3/b/${cloudBinId}`;
      method = 'PUT';
    } else {
      url = 'https://api.jsonbin.io/v3/b';
      method = 'POST';
    }
    const r = await fetch(url, {
      method,
      headers: {
        'Content-Type': 'application/json',
        'X-Master-Key': JSONBIN_KEY,
        'X-Bin-Name': 'scp-foundation-db',
        'X-Bin-Private': 'false'
      },
      body: JSON.stringify(entities)
    });
    if (!r.ok) throw new Error(r.status);
    const data = await r.json();
    if (!cloudBinId) {
      cloudBinId = data.metadata.id;
      localStorage.setItem('scp_bin_id', cloudBinId);
      toast('‚òÅ –ö–û–†–ó–ò–ù–ê –°–û–ó–î–ê–ù–ê! ID: ' + cloudBinId);
    } else {
      toast('‚òÅ –°–ò–ù–•–†–û–ù–ò–ó–ò–†–û–í–ê–ù–û –° –°–ï–†–í–ï–†–û–ú');
    }
    localStorage.setItem('scp_db', JSON.stringify(entities));
    updateSyncBadge('cloud');
  } catch(e) {
    updateSyncBadge('error');
    toast('–û–®–ò–ë–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ù–ê –°–ï–†–í–ï–†: ' + e.message);
  }
}

// ‚îÄ‚îÄ‚îÄ CLOUD: –ø–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ‚îÄ‚îÄ‚îÄ
function openCloudSetup() {
  openOverlay('cloudOverlay');
  document.getElementById('cloudKeyInput').value = localStorage.getItem('scp_jbkey') || '';
  document.getElementById('cloudBinInput').value = localStorage.getItem('scp_bin_id') || '';
  const binId = localStorage.getItem('scp_bin_id');
  const key = localStorage.getItem('scp_jbkey');
  const info = document.getElementById('cloudStatusInfo');
  if (key && binId) {
    info.innerHTML = `<span style="color:var(--green);">‚óè –ü–û–î–ö–õ–Æ–ß–ï–ù–û</span> ‚Äî ID –∫–æ—Ä–∑–∏–Ω—ã: <span style="color:var(--amber);">${binId}</span><br>–°—Å—ã–ª–∫–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è: <a href="https://api.jsonbin.io/v3/b/${binId}/latest" target="_blank" style="color:var(--amber);word-break:break-all;">jsonbin.io/v3/b/${binId}</a>`;
  } else if (key) {
    info.innerHTML = '<span style="color:var(--amber);">‚ö† –ö–ª—é—á –µ—Å—Ç—å, –Ω–æ –∫–æ—Ä–∑–∏–Ω–∞ –µ—â—ë –Ω–µ —Å–æ–∑–¥–∞–Ω–∞ ‚Äî —Å–æ—Ö—Ä–∞–Ω–∏ —Å—Ç–∞—Ç—å—é.</span>';
  } else {
    info.innerHTML = '<span style="color:var(--text-dim);">‚¨° –û–±–ª–∞–∫–æ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ ‚Äî —Å—Ç–∞—Ç—å–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –ª–æ–∫–∞–ª—å–Ω–æ.</span>';
  }
}

function saveCloudConfig() {
  const key = document.getElementById('cloudKeyInput').value.trim();
  const bin = document.getElementById('cloudBinInput').value.trim();
  if (!key) { toast('–í–í–ï–î–ò–¢–ï API –ö–õ–Æ–ß'); return; }
  localStorage.setItem('scp_jbkey', key);
  if (bin) { localStorage.setItem('scp_bin_id', bin); cloudBinId = bin; }
  closeModal('cloudOverlay');
  location.reload(); // –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
}

function clearCloudConfig() {
  if (!confirm('–û—Ç–≤—è–∑–∞—Ç—å –æ–±–ª–∞–∫–æ? –î–∞–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω—É—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ.')) return;
  localStorage.removeItem('scp_jbkey');
  localStorage.removeItem('scp_bin_id');
  toast('–û–ë–õ–ê–ö–û –û–¢–ö–õ–Æ–ß–ï–ù–û');
  closeModal('cloudOverlay');
  location.reload();
}

// ‚îÄ‚îÄ‚îÄ —ç–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª ‚îÄ‚îÄ‚îÄ
function exportDB() {
  saveCurrent();
  const blob = new Blob([JSON.stringify(entities, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'scp-database.json';
  a.click();
  toast('–ë–ê–ó–ê –≠–ö–°–ü–û–†–¢–ò–†–û–í–ê–ù–ê –í –§–ê–ô–õ');
}

// ‚îÄ‚îÄ‚îÄ –∏–º–ø–æ—Ä—Ç –∏–∑ —Ñ–∞–π–ª–∞ ‚îÄ‚îÄ‚îÄ
function importDB(ev) {
  const file = ev.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (!Array.isArray(data)) throw new Error('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç');
      if (!confirm(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å ${data.length} –æ–±—ä–µ–∫—Ç(–æ–≤)? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.`)) return;
      entities = data;
      localStorage.setItem('scp_db', JSON.stringify(entities));
      renderList();
      if (entities.length) selectEntity(entities[0].id); else activeId = null;
      toast('–ë–ê–ó–ê –ò–ú–ü–û–†–¢–ò–†–û–í–ê–ù–ê: ' + data.length + ' –æ–±—ä–µ–∫—Ç–æ–≤');
    } catch(err) { toast('–û–®–ò–ë–ö–ê –ò–ú–ü–û–†–¢–ê: ' + err.message); }
  };
  reader.readAsText(file);
  ev.target.value = '';
}

// ‚îÄ‚îÄ‚îÄ –∑–Ω–∞—á–æ–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ‚îÄ‚îÄ‚îÄ
function updateSyncBadge(status) {
  const b = document.getElementById('syncBadge');
  if (!b) return;
  const cfg = {
    local:   { text:'‚óè –õ–û–ö–ê–õ–¨–ù–û',    color:'var(--text-dim)',  border:'var(--border2)' },
    cloud:   { text:'‚òÅ –û–ë–õ–ê–ö–û',      color:'#4488cc',          border:'#224466' },
    syncing: { text:'‚Üª –°–ò–ù–•–†...',    color:'var(--amber)',      border:'var(--amber-dim)' },
    error:   { text:'‚úï –û–®–ò–ë–ö–ê SYNC', color:'var(--red)',        border:'var(--red2)' },
  };
  const s = cfg[status] || cfg.local;
  b.textContent = s.text;
  b.style.color = s.color;
  b.style.borderColor = s.border;
}

setInterval(() => { if (activeId && isAdmin) saveAll(); }, 30000);

document.addEventListener('keydown', ev => {
  if (document.getElementById('authOverlay').classList.contains('open')) return;
  if ((ev.ctrlKey || ev.metaKey) && ev.key === 's') { ev.preventDefault(); if (isAdmin) saveAll(); }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openOverlay(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(o => o.addEventListener('click', ev => { if (ev.target===o) o.classList.remove('open'); }));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = '// ' + msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2800);
}
</script>
</body>
</html>
